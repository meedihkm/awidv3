name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  test-backend:
    name: Test Backend (Node.js)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./api-v2

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: api-v2/package-lock.json

    - name: Install Dependencies
      run: npm ci

    - name: Run Tests
      run: npm test
      env:
        NODE_ENV: test
        JWT_SECRET: test_secret

  test-mobile:
    name: Test Mobile (Flutter)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./mobile

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.6'
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get

    - name: Run Tests
      run: flutter test

  deploy-staging:
    name: Deploy to Staging
    needs: [test-backend, test-mobile]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Vercel CLI
      run: npm install --global vercel@latest

    - name: Deploy to Vercel (Production Mode for Staging env)
      run: vercel --token ${VERCEL_TOKEN} --prod --scope awid --yes
      # Note: Usually Staging is a Preview deployment, but here assuming we want a persistent URL?
      # Vercel Preview is automatic on PR.
      # If we specific want 'staging' env, we might map it differently.
      # For now, let's assume develop branch -> Preview URL or specific Alias.

    - name: Health Check
      run: |
        chmod +x ./scripts/health-check.sh
        ./scripts/health-check.sh https://awid-staging.vercel.app

  deploy-production:
    name: Deploy to Production
    needs: [test-backend, test-mobile]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Vercel CLI
      run: npm install --global vercel@latest

    - name: Deploy to Vercel
      run: vercel --token ${VERCEL_TOKEN} --prod --scope awid --yes

    - name: Health Check
      run: |
        chmod +x ./scripts/health-check.sh
        ./scripts/health-check.sh https://api.awid.com

  notify-slack:
    name: Notify Slack
    needs: [deploy-production]
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_MESSAGE: 'Deployment to Production finished with status ${{ job.status }}'
          SLACK_TITLE: Deployed Awid App
